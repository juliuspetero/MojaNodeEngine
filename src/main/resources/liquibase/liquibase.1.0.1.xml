<databaseChangeLog xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
                   xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
                   xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.0.xsd">

    <changeSet id="create-table-wallet" author="juliuspetero@outlook.com">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="wallet"/>
            </not>
        </preConditions>
        <comment>Create table for customer wallets</comment>
        <createTable tableName="wallet">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="actual_balance" type="decimal(19,4)">
                <constraints nullable="false"/>
            </column>
            <column name="available_balance" type="decimal(19,4)">
                <constraints nullable="false"/>
            </column>
            <column name="on_hold_balance" type="decimal(19,4)">
                <constraints nullable="false"/>
            </column>
            <column name="number_of_transactions" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="account_id" type="bigint">
                <constraints nullable="true" foreignKeyName="27072021_FK_wallet_account_id"
                             references="account(id)"/>
            </column>
            <column name="company_id" type="bigint">
                <constraints nullable="true" foreignKeyName="27072021_FK_wallet_company_id"
                             references="company(id)"/>
            </column>
            <column name="branch_id" type="bigint">
                <constraints nullable="true" foreignKeyName="27072021_FK_wallet_branch_id"
                             references="branch(id)"/>
            </column>
            <column name="created_on" type="timestamp" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="modified_on" type="timestamp" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="modified_by" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="record_status" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create-table-wallet_charge" author="juliuspetero@outlook.com">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="wallet_charge"/>
            </not>
        </preConditions>
        <comment>Create table for wallet charge</comment>
        <createTable tableName="wallet_charge">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false" unique="true" uniqueConstraintName="unique_wallet_charge_name"/>
            </column>
            <column name="description" type="longtext">
                <constraints nullable="false"/>
            </column>
            <column name="amount" type="decimal(19,4)">
                <constraints nullable="false"/>
            </column>
            <column name="fee_type_enum" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="charge_type_enum" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="currency_code" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_on" type="timestamp" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="modified_on" type="timestamp" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="modified_by" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="record_status" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create-table-wallet_wallet_charge" author="juliuspetero@outlook.com">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="wallet_wallet_charge"/>
            </not>
        </preConditions>
        <comment>Create join table for wallet and wallet charge</comment>
        <createTable tableName="wallet_wallet_charge">
            <column name="wallet_id" type="bigint">
                <constraints nullable="false" foreignKeyName="27072021_FK_wwc_wallet_id"
                             references="wallet(id)"/>
            </column>
            <column name="wallet_charge_id" type="bigint">
                <constraints nullable="false"
                             foreignKeyName="27072021_FK_role_27072021_FK_wwc_wallet_charge_id"
                             references="wallet_charge(id)"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create-table-wallet_transaction" author="juliuspetero@outlook.com">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="wallet_transaction"/>
            </not>
        </preConditions>
        <comment>Create table for keeping wallet transactions</comment>
        <createTable tableName="wallet_transaction">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="wallet_id" type="bigint">
                <constraints nullable="false" foreignKeyName="27072021_FK_recipient_id"
                             references="wallet(id)"/>
            </column>
            <column name="transaction_type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="amount" type="decimal(19,4)">
                <constraints nullable="false"/>
            </column>
            <column name="transaction_status" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="wallet_transaction_request_id" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="bank_deposit_transaction_id" type="bigint">
                <constraints nullable="true"/>
            </column>
            <column name="created_on" type="timestamp" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="modified_on" type="timestamp" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="modified_by" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="record_status" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create-table-recipient_bank_detail" author="juliuspetero@outlook.com">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="recipient_bank_detail"/>
            </not>
        </preConditions>
        <comment>Create table for keeping all the recipient bank information</comment>
        <createTable tableName="recipient_bank_detail">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="bank_name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="account_name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="account_number" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="branch_name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="swift_code" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_on" type="timestamp" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="modified_on" type="timestamp" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="modified_by" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="record_status" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create-table-recipient" author="juliuspetero@outlook.com">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="recipient"/>
            </not>
        </preConditions>
        <comment>Create table for keeping all the recipients</comment>
        <createTable tableName="recipient">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="first_name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="last_name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="date_of_birth" type="date">
                <constraints nullable="false"/>
            </column>
            <column name="id_number" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="id_type_enum" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="address" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="email" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="phone_number" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="recipient_bank_detail_id" type="bigint">
                <constraints nullable="false" foreignKeyName="27072021_FK_recipient_bank_detail_id"
                             references="recipient_bank_detail(id)"/>
            </column>
            <column name="account_id" type="bigint">
                <constraints nullable="true" foreignKeyName="29072021_FK_recipient_account_id"
                             references="account(id)"/>
            </column>
            <column name="company_id" type="bigint">
                <constraints nullable="true" foreignKeyName="27072021_FK_recipient_company_id"
                             references="company(id)"/>
            </column>
            <column name="branch_id" type="bigint">
                <constraints nullable="true" foreignKeyName="27072021_FK_recipient_branch_id"
                             references="branch(id)"/>
            </column>
            <column name="created_on" type="timestamp" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="modified_on" type="timestamp" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="modified_by" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="record_status" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create-table-recipient_transaction" author="juliuspetero@outlook.com">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="recipient_transaction"/>
            </not>
        </preConditions>
        <comment>Create table for keeping recipient transactions</comment>
        <createTable tableName="recipient_transaction">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="recipient_id" type="bigint">
                <constraints nullable="false" foreignKeyName="27072021_FK_rt_recipient_id"
                             references="recipient(id)"/>
            </column>
            <column name="wallet_transaction_id" type="bigint">
                <constraints nullable="false" foreignKeyName="27072021_FK_rt_wallet_transaction_id"
                             references="wallet_transaction(id)"/>
            </column>
            <column name="amount" type="decimal(19,4)">
                <constraints nullable="false"/>
            </column>
            <column name="phone_number" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="bank_account_number" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="transaction_status" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="transaction_type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="payment_method_type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="platform_type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="created_on" type="timestamp" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="modified_on" type="timestamp" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="modified_by" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="record_status" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create-table-s3_document" author="juliuspetero@outlook.com">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="s3_document"/>
            </not>
        </preConditions>
        <comment>Create table for keeping s3 uploaded documents</comment>
        <createTable tableName="s3_document">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="mime_type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="path" type="varchar(500)">
                <constraints nullable="false"/>
            </column>
            <column name="upload_type_enum" type="varchar(255)">
                <constraints nullable="false"/>
            </column>

            <column name="wallet_transaction_request_id" type="bigint">
                <constraints nullable="true"/>
            </column>
            <column name="created_on" type="timestamp" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="modified_on" type="timestamp" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="modified_by" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="record_status" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create-table-bank_deposit_transaction" author="juliuspetero@outlook.com">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="bank_deposit_transaction"/>
            </not>
        </preConditions>
        <comment>Create table for keeping all the topup bank details</comment>
        <createTable tableName="bank_deposit_transaction">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="receiver_bank_name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="receiver_bank_branch" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="receiver_account_number" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="receiver_account_name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="depositor_name" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="amount" type="decimal(19,4)">
                <constraints nullable="false"/>
            </column>
            <column name="deposit_date" type="date">
                <constraints nullable="false"/>
            </column>
            <column name="comment" type="varchar(255)">
                <constraints nullable="true"/>
            </column>
            <column name="created_on" type="timestamp" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="modified_on" type="timestamp" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="modified_by" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="record_status" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create-table-wallet_transaction_request" author="juliuspetero@outlook.com">
        <preConditions onFail="MARK_RAN">
            <not>
                <tableExists tableName="wallet_transaction_request"/>
            </not>
        </preConditions>
        <comment>Create table for keeping all the transaction requests</comment>
        <createTable tableName="wallet_transaction_request">
            <column name="id" type="bigint" autoIncrement="true">
                <constraints nullable="false" primaryKey="true"/>
            </column>
            <column name="wallet_id" type="bigint">
                <constraints nullable="true" foreignKeyName="1308_FK_deposit_wallet_id"
                             references="wallet(id)"/>
            </column>
            <column name="transaction_type" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="transaction_status" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
            <column name="amount" type="decimal(19,4)">
                <constraints nullable="false"/>
            </column>
            <column name="approved_by" type="bigint">
                <constraints nullable="true" foreignKeyName="1308_FK_deposit_approved_by"
                             references="app_user(id)"/>
            </column>
            <column name="approved_on" type="timestamp" defaultValueComputed="now()">
                <constraints nullable="true"/>
            </column>
            <column name="created_on" type="timestamp" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="modified_on" type="timestamp" defaultValueComputed="now()">
                <constraints nullable="false"/>
            </column>
            <column name="created_by" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="modified_by" type="bigint">
                <constraints nullable="false"/>
            </column>
            <column name="record_status" type="varchar(255)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <addForeignKeyConstraint baseTableName="wallet_transaction" baseColumnNames="wallet_transaction_request_id"
                                 constraintName="1308021_FK_wallet_transaction_request_id"
                                 referencedTableName="wallet_transaction_request"
                                 referencedColumnNames="id"/>
        <addForeignKeyConstraint baseTableName="wallet_transaction" baseColumnNames="bank_deposit_transaction_id"
                                 constraintName="1308021_FK_bank_deposit_transaction_id"
                                 referencedTableName="bank_deposit_transaction"
                                 referencedColumnNames="id"/>
    </changeSet>

    <changeSet id="add-wallet-permissions" author="juliuspetero@outlook.com">
        <comment>Create wallet permissions for all users</comment>
        <sql>
            <![CDATA[
            -- Wallet permissions
            INSERT
            IGNORE INTO permission(name, action_type, entity_type, category)
                VALUES ('READ_WALLETS', 'READ', 'WALLET', 'GENERAL'),
                ('CREATE_WALLETS', 'CREATE', 'WALLET', 'BACK_OFFICE'),
                ('UPDATE_WALLETS', 'UPDATE', 'WALLET', 'BACK_OFFICE'),
                ('ACTIVATE_WALLETS', 'ACTIVATE', 'WALLET', 'BACK_OFFICE'),
                ('DEACTIVATE_WALLETS', 'DEACTIVATE', 'WALLET', 'BACK_OFFICE'),
                ('TOP_UP_WALLETS', 'TOP_UP', 'WALLET', 'GENERAL'),
                ('APPLY_WALLET_CHARGES', 'APPLY_CHARGE', 'WALLET', 'BACK_OFFICE');

            -- Wallet charge permissions
            INSERT
            IGNORE INTO permission(name, action_type, entity_type, category)
                VALUES ('READ_WALLET_CHARGES', 'READ', 'WALLET_CHARGE', 'BACK_OFFICE'),
                ('CREATE_WALLET_CHARGES', 'CREATE', 'WALLET_CHARGE', 'BACK_OFFICE'),
                ('UPDATE_WALLET_CHARGES', 'UPDATE', 'WALLET_CHARGE', 'BACK_OFFICE'),
                ('ACTIVATE_WALLET_CHARGES', 'ACTIVATE', 'WALLET_CHARGE', 'BACK_OFFICE'),
                ('DEACTIVATE_WALLET_CHARGES', 'DEACTIVATE', 'WALLET_CHARGE', 'BACK_OFFICE');
            ]]>
        </sql>
    </changeSet>

    <changeSet id="insert_operation/backoffice_account" author="juliuspetero@outlook.com">
        <preConditions onFail="MARK_RAN">
            <sqlCheck expectedResult="0">
                SELECT COUNT(*) FROM wallet_charge;
            </sqlCheck>
        </preConditions>

        <comment>Insert default wallet charge</comment>
        <sql>
            <![CDATA[
            INSERT
            IGNORE INTO wallet_charge (name, description, amount, fee_type_enum, charge_type_enum, currency_code, created_by,
                                  modified_by, record_status)
                VALUES ('Default Disbursement Charge', 'This charge is attached to all wallet created', 1000.0000, 'FLAT',
                        'DISBURSEMENT_CHARGE', 'UGX', (SELECT app_user.id FROM app_user LIMIT 1),
                        (SELECT app_user.id FROM app_user LIMIT 1), 'ACTIVE');

            INSERT
            IGNORE INTO wallet(actual_balance, available_balance, on_hold_balance, number_of_transactions, account_id,
                                          created_by, modified_by, record_status)
                VALUES (0.0000, 0.0000, 0.0000, 0, (SELECT account.id FROM account WHERE account.account_type = 'BACK_OFFICE' LIMIT 1),
                        (SELECT app_user.id FROM app_user LIMIT 1), (SELECT app_user.id FROM app_user LIMIT 1), 'ACTIVE');

            INSERT
            IGNORE INTO wallet_wallet_charge(wallet_id, wallet_charge_id)
                VALUES ((SELECT wallet.id FROM wallet LIMIT 1), (SELECT wallet_charge.id FROM wallet_charge LIMIT 1));
            ]]>
        </sql>
    </changeSet>

</databaseChangeLog>